name: PR checks

on:
  push:
    branches:
      - feat/snapshot-testing
#  pull_request:
#    branches:
#      - feat/snapshot-testing

jobs:
  test:
    name: Test against snapshots
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: jwalton/gh-find-current-pr@v1
      id: findPr
      with:
        # Can be "open", "closed", or "all".  Defaults to "open".
        state: open
        # This will echo "Your PR is 7", or be skipped if there is no current PR.
    - run: echo "Your PR is ${PR}"
      if: success() && steps.findPr.outputs.number
      env:
        PR: ${{ steps.findPr.outputs.pr }}

    - name: Set up Java 11
      uses: actions/setup-java@v1
      with:
        java-version: '11'

    - name: Gradle - Verify snapshots with Paparazzi
      id: testStep
      run: ./gradlew clean snapshot-test:verifyPaparazziDebug

    - name: Upload snapshot failure deltas
      if: failure()
      uses: actions/upload-artifact@v2
      with:
        name: snapshot-failure-deltas
        path: snapshot-test/out/failures/delta-*.png

    - name: Find Comment on PR
      uses: peter-evans/find-comment@v1
      id: fc
      with:
        issue-number: ${{ steps.findPr.outputs.pr }}
        comment-author: 'github-actions[bot]'
        body-includes: Snapshot testing result

    - name: Create or update comment on PR (Success)
      uses: peter-evans/create-or-update-comment@v1
      if: steps.testStep.outcome == 'success'
      with:
        comment-id: ${{ steps.fc.outputs.comment-id }}
        issue-number: ${{ steps.findPr.outputs.pr }}
        body: |
          Snapshot testing result: Success!
        edit-mode: replace
        reactions: hooray

    - name: Create or update comment on PR (Failure)
      uses: peter-evans/create-or-update-comment@v1
      if: steps.testStep.outcome == 'failure'
      with:
        comment-id: ${{ steps.fc.outputs.comment-id }}
        issue-number: ${{ steps.findPr.outputs.pr }}
        body: |
          Snapshot testing result:
          Some of the snapshot tests seem to have failed. Please:
          - Head over to the artifacts section of the [CI Run](https://github.com/loukwn/StageStepBar/actions/runs/${{ github.run_id }})
          - Download the zip
          - If these changes are fixing an issue then please speak to the maintainer. If they are not intended then please fix them and repush again.
        edit-mode: replace
        reactions: confused
